<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Produção Cirúrgica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #search-results {
            position: absolute; width: 100%; z-index: 10;
            max-height: 300px; overflow-y: auto;
            border: 1px solid #e2e8f0; border-top: none;
        }
        #search-results div:hover { background-color: #f1f5f9; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Navbar Atualizada -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto max-w-3xl p-4 flex justify-start items-center space-x-6">
            <a href="/" class="text-gray-500 hover:text-blue-600 font-medium transition-colors flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                INÍCIO
            </a>
            <a href="/producao" class="text-blue-600 font-bold border-b-2 border-blue-600 pb-1 transition-colors">PRODUÇÃO</a>
            <a href="/consulta" class="text-gray-500 hover:text-blue-600 font-medium pb-1 transition-colors">CONSULTA</a>
            <a href="/medicos" class="text-gray-500 hover:text-blue-600 font-medium pb-1 transition-colors">MÉDICOS</a>
        </div>
    </nav>

    <div class="container mx-auto max-w-3xl p-6 bg-white shadow-lg rounded-lg mt-8">
        
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">
            Lançamento de Produção
        </h1>

        <div id="message-box" class="hidden p-4 rounded-md mb-4 text-white text-center font-medium shadow"></div>

        <form id="producao-form" class="space-y-6">

            <!-- Busca -->
            <div class="relative">
                <label for="procedimento-search" class="block text-sm font-medium text-gray-700 mb-1">
                    Buscar Procedimento (digite 3+ letras)
                </label>
                <div class="relative">
                    <input type="text" id="procedimento-search"
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                           placeholder="Ex: Herniorrafia..."
                           autocomplete="off">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div id="search-results" class="bg-white rounded-b-md shadow-lg hidden"></div>
            </div>

            <!-- Campos Automáticos -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-4 rounded-md border border-gray-200">
                <div>
                    <label for="codigo-sigtap" class="block text-sm font-medium text-gray-700 mb-1">
                        Código SIGTAP
                    </label>
                    <input type="text" id="codigo-sigtap"
                           class="w-full px-4 py-2 bg-gray-200 border border-gray-300 rounded-md shadow-sm text-gray-600 cursor-not-allowed"
                           readonly>
                </div>
                <div>
                    <label for="valor-sigtap" class="block text-sm font-medium text-gray-700 mb-1">
                        Valor SIGTAP (R$)
                    </label>
                    <input type="text" id="valor-sigtap"
                           class="w-full px-4 py-2 bg-gray-200 border border-gray-300 rounded-md shadow-sm text-gray-600 cursor-not-allowed"
                           readonly>
                </div>
            </div>

            <!-- Detalhes Adicionais -->
            <div id="extra-info" class="hidden grid grid-cols-2 gap-4 text-sm text-gray-600 px-4">
                <div><span class="font-bold">Tipo:</span> <span id="info-tipo">---</span></div>
                <div><span class="font-bold">Especialidade:</span> <span id="info-esp">---</span></div>
            </div>

            <!-- Dados de Entrada -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="mes" class="block text-sm font-medium text-gray-700 mb-1">Mês</label>
                    <select id="mes" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 bg-white">
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div>
                    <label for="ano" class="block text-sm font-medium text-gray-700 mb-1">Ano</label>
                    <select id="ano" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 bg-white"></select>
                </div>
                <div>
                    <label for="quantidade" class="block text-sm font-medium text-gray-700 mb-1">Quantidade</label>
                    <input type="number" id="quantidade" min="1"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500"
                           placeholder="0">
                </div>
            </div>

            <div class="text-right pt-4 border-t mt-6">
                <button type="submit" id="submit-button"
                        class="inline-flex justify-center w-full md:w-auto py-3 px-8 border border-transparent shadow-md text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all">
                    Registrar Produção
                </button>
            </div>
        </form>
    </div>

    <footer class="text-center text-gray-500 text-sm mt-8 pb-6">Sistema de Produção v2.3</footer>

    <script>
        const procSearchInput = document.getElementById('procedimento-search');
        const searchResultsContainer = document.getElementById('search-results');
        const codigoSigtapInput = document.getElementById('codigo-sigtap'); 
        const valorSigtapInput = document.getElementById('valor-sigtap');
        const mesSelect = document.getElementById('mes');
        const anoSelect = document.getElementById('ano');
        const quantidadeInput = document.getElementById('quantidade');
        const form = document.getElementById('producao-form');
        const submitButton = document.getElementById('submit-button');
        const messageBox = document.getElementById('message-box');
        
        const extraInfo = document.getElementById('extra-info');
        const infoTipo = document.getElementById('info-tipo');
        const infoEsp = document.getElementById('info-esp');

        let selectedProcedimento = null;
        let searchTimeout;

        function formatCurrency(value) {
            if (value === null || value === undefined) return '';
            return parseFloat(value).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function popularDropdownsData() {
            const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            mesSelect.innerHTML = '<option value="">Selecione o Mês...</option>';
            meses.forEach((mes, index) => {
                mesSelect.innerHTML += `<option value="${index + 1}">${mes}</option>`;
            });
            const anoAtual = new Date().getFullYear();
            anoSelect.innerHTML = '';
            for (let i = anoAtual + 1; i >= 2020; i--) {
                const selected = (i === anoAtual) ? 'selected' : '';
                anoSelect.innerHTML += `<option value="${i}" ${selected}>${i}</option>`;
            }
        }

        function resetForm() {
            procSearchInput.value = '';
            codigoSigtapInput.value = '';
            valorSigtapInput.value = '';
            mesSelect.value = '';
            quantidadeInput.value = '';
            extraInfo.classList.add('hidden');
            selectedProcedimento = null;
        }

        function showMessage(type, text) {
            messageBox.innerHTML = text;
            messageBox.className = type === 'success' 
                ? 'p-4 rounded-md mb-4 text-white text-center font-medium shadow bg-green-500'
                : 'p-4 rounded-md mb-4 text-white text-center font-medium shadow bg-red-500';
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        function handleSelectProcedimento(proc) {
            selectedProcedimento = proc;
            procSearchInput.value = proc.nome;
            codigoSigtapInput.value = proc.codigo_sigtap; 
            valorSigtapInput.value = formatCurrency(proc.valor_sigtap);
            
            if(proc.tipo_cirurgia || proc.nome_especialidade){
                infoTipo.textContent = proc.tipo_cirurgia || '-';
                infoEsp.textContent = proc.nome_especialidade || '-';
                extraInfo.classList.remove('hidden');
            }

            searchResultsContainer.innerHTML = '';
            searchResultsContainer.classList.add('hidden');
        }

        async function fetchProcedimentos(term) {
            if (term.length < 3) {
                searchResultsContainer.innerHTML = '';
                searchResultsContainer.classList.add('hidden');
                return;
            }
            try {
                const response = await fetch(`/api/search_procedimento?term=${encodeURIComponent(term)}`);
                if (!response.ok) return;
                const procedimentos = await response.json();
                
                searchResultsContainer.innerHTML = '';
                if (procedimentos.length === 0) {
                    searchResultsContainer.innerHTML = `<div class="p-3 text-gray-500 italic">Nenhum procedimento encontrado.</div>`;
                } else {
                    procedimentos.forEach(proc => {
                        const div = document.createElement('div');
                        div.className = 'p-3 cursor-pointer hover:bg-blue-50 border-b border-gray-100 text-sm text-gray-700';
                        div.innerHTML = `<strong>${proc.nome}</strong> <span class="text-gray-400 text-xs block">${proc.codigo_sigtap}</span>`;
                        div.onclick = () => handleSelectProcedimento(proc);
                        searchResultsContainer.appendChild(div);
                    });
                }
                searchResultsContainer.classList.remove('hidden');
            } catch (error) {
                console.error("Erro busca:", error);
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            if (!selectedProcedimento || codigoSigtapInput.value !== selectedProcedimento.codigo_sigtap) {
                showMessage('error', 'Erro: Procedimento inválido. Selecione na lista.');
                return;
            }
            if (!mesSelect.value || !anoSelect.value || !quantidadeInput.value || quantidadeInput.value <= 0) {
                showMessage('error', 'Erro: Preencha todos os campos.');
                return;
            }

            const confirmMessage = `Confirma?\n\n${selectedProcedimento.nome}\nQtd: ${quantidadeInput.value} em ${mesSelect.options[mesSelect.selectedIndex].text}/${anoSelect.value}`;
            if (!confirm(confirmMessage)) return;

            const payload = {
                codigo_sigtap: selectedProcedimento.codigo_sigtap,
                ano: parseInt(anoSelect.value),
                mes: parseInt(mesSelect.value),
                quantidade: parseInt(quantidadeInput.value)
            };

            submitButton.disabled = true;
            submitButton.textContent = 'Salvando...';

            try {
                const response = await fetch('/api/submit_producao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (response.ok && result.success) {
                    showMessage('success', '✅ Produção atualizada com sucesso!');
                    resetForm();
                } else {
                    showMessage('error', `❌ Erro: ${result.message}`);
                }
            } catch (error) {
                showMessage('error', '❌ Erro de conexão.');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Registrar Produção';
            }
        }

        procSearchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const term = e.target.value;
            if (term.length === 0) {
                resetForm();
                searchResultsContainer.classList.add('hidden');
            } else {
                searchTimeout = setTimeout(() => fetchProcedimentos(term), 300);
            }
        });

        document.addEventListener('click', (e) => {
            if (!procSearchInput.contains(e.target) && !searchResultsContainer.contains(e.target)) {
                searchResultsContainer.classList.add('hidden');
            }
        });

        form.addEventListener('submit', handleSubmit);
        popularDropdownsData();
    </script>
</body>
</html>