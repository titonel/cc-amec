<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Produção Cirúrgica</title>
    <!-- Carrega o Tailwind CSS via CDN para estilização rápida -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para o container de resultados da busca */
        #search-results {
            position: absolute;
            width: 100%;
            z-index: 10;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-top: none;
        }
        #search-results div:hover {
            background-color: #f1f5f9;
        }
        /* Esconde a barra de rolagem padrão do input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="container mx-auto max-w-3xl p-6 bg-white shadow-lg rounded-lg mt-10">
        
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">
            Registro de Produção Cirúrgica
        </h1>

        <!-- Mensagens de feedback (sucesso ou erro) -->
        <div id="message-box" class="hidden p-4 rounded-md mb-4 text-white"></div>

        <!-- Formulário de Inserção -->
        <form id="producao-form" class="space-y-6">

            <!-- Seção do Procedimento com Busca -->
            <div class="relative">
                <label for="procedimento-search" class="block text-sm font-medium text-gray-700 mb-1">
                    Buscar Procedimento (digite 3+ letras)
                </label>
                <input type="text" id="procedimento-search"
                       class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Ex: Herniorrafia..."
                       autocomplete="off">
                <!-- Container onde os resultados da busca aparecerão -->
                <div id="search-results" class="bg-white rounded-b-md shadow-lg"></div>
            </div>

            <!-- Campos auto-preenchidos -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="codigo-sus" class="block text-sm font-medium text-gray-700 mb-1">
                        Código SUS
                    </label>
                    <input type="text" id="codigo-sus"
                           class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm"
                           readonly>
                </div>
                <div>
                    <label for="valor-sigtap" class="block text-sm font-medium text-gray-700 mb-1">
                        Valor SIGTAP (R$)
                    </label>
                    <input type="text" id="valor-sigtap"
                           class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm"
                           readonly>
                </div>
            </div>

            <!-- Seção de Data e Quantidade -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="mes" class="block text-sm font-medium text-gray-700 mb-1">
                        Mês
                    </label>
                    <select id="mes" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecione...</option>
                        <!-- Os meses serão populados por JS -->
                    </select>
                </div>
                <div>
                    <label for="ano" class="block text-sm font-medium text-gray-700 mb-1">
                        Ano
                    </label>
                    <select id="ano" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <!-- Os anos serão populados por JS -->
                    </select>
                </div>
                <div>
                    <label for="quantidade" class="block text-sm font-medium text-gray-700 mb-1">
                        Quantidade
                    </label>
                    <input type="number" id="quantidade" min="1"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                           placeholder="0">
                </div>
            </div>

            <!-- Botão de Envio -->
            <div class="text-right pt-4">
                <button type="submit" id="submit-button"
                        class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
                    Registrar Produção
                </button>
            </div>
        </form>
    </div>

    <footer class="text-center text-gray-500 text-sm mt-6 pb-6">
        Sistema de Registro de Produção v1.0
    </footer>

    <script>
        // --- Seletores de Elementos do DOM ---
        const procSearchInput = document.getElementById('procedimento-search');
        const searchResultsContainer = document.getElementById('search-results');
        const codigoSusInput = document.getElementById('codigo-sus');
        const valorSigtapInput = document.getElementById('valor-sigtap');
        const mesSelect = document.getElementById('mes');
        const anoSelect = document.getElementById('ano');
        const quantidadeInput = document.getElementById('quantidade');
        const form = document.getElementById('producao-form');
        const submitButton = document.getElementById('submit-button');
        const messageBox = document.getElementById('message-box');

        // --- Variáveis de Estado ---
        let selectedProcedimento = null; // Guarda o objeto do procedimento selecionado
        let searchTimeout;

        // --- Funções Auxiliares ---

        /**
         * Formata um número como moeda BRL (ex: 123.4 -> 123,40)
         */
        function formatCurrency(value) {
            if (value === null || value === undefined) return '';
            return parseFloat(value).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        /**
         * Popula os dropdowns de Mês e Ano
         */
        function popularDropdownsData() {
            // Popula Meses
            const meses = [
                "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
                "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
            ];
            mesSelect.innerHTML = '<option value="">Selecione o Mês...</option>';
            meses.forEach((mes, index) => {
                mesSelect.innerHTML += `<option value="${index + 1}">${mes}</option>`;
            });

            // Popula Anos (Ano atual +/- 2 anos)
            const anoAtual = new Date().getFullYear();
            anoSelect.innerHTML = '';
            for (let i = anoAtual + 1; i >= anoAtual - 3; i--) {
                const selected = (i === anoAtual) ? 'selected' : '';
                anoSelect.innerHTML += `<option value="${i}" ${selected}>${i}</option>`;
            }
        }

        /**
         * Reseta os campos do formulário para o estado inicial
         */
        function resetForm() {
            procSearchInput.value = '';
            codigoSusInput.value = '';
            valorSigtapInput.value = '';
            mesSelect.value = '';
            quantidadeInput.value = '';
            selectedProcedimento = null;
            // Deixa o ano selecionado (geralmente o atual)
        }

        /**
         * Mostra uma mensagem de feedback (erro ou sucesso)
         */
        function showMessage(type, text) {
            messageBox.innerHTML = text;
            if (type === 'success') {
                messageBox.className = 'p-4 rounded-md mb-4 text-white bg-green-500';
            } else {
                messageBox.className = 'p-4 rounded-md mb-4 text-white bg-red-500';
            }
            messageBox.classList.remove('hidden');
            
            // Esconde a mensagem após 5 segundos
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // --- Lógica Principal ---

        /**
         * Lida com a seleção de um procedimento da lista de busca
         */
        function handleSelectProcedimento(proc) {
            selectedProcedimento = proc;
            procSearchInput.value = proc.nome;
            codigoSusInput.value = proc.codigo_sus;
            valorSigtapInput.value = formatCurrency(proc.valor_sigtap);
            searchResultsContainer.innerHTML = ''; // Limpa resultados
            searchResultsContainer.classList.add('hidden'); // Esconde container
        }

        /**
         * Busca procedimentos na API com base no input do usuário
         */
        async function fetchProcedimentos(term) {
            if (term.length < 3) {
                searchResultsContainer.innerHTML = '';
                searchResultsContainer.classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(`/api/search_procedimento?term=${encodeURIComponent(term)}`);
                if (!response.ok) return;

                const procedimentos = await response.json();
                
                searchResultsContainer.innerHTML = ''; // Limpa resultados antigos
                if (procedimentos.length === 0) {
                    searchResultsContainer.innerHTML = `<div class="p-3 text-gray-500">Nenhum procedimento encontrado.</div>`;
                } else {
                    procedimentos.forEach(proc => {
                        const div = document.createElement('div');
                        div.className = 'p-3 cursor-pointer hover:bg-gray-100';
                        div.textContent = proc.nome;
                        div.onclick = () => handleSelectProcedimento(proc);
                        searchResultsContainer.appendChild(div);
                    });
                }
                searchResultsContainer.classList.remove('hidden'); // Mostra container

            } catch (error) {
                console.error("Erro ao buscar procedimentos:", error);
                searchResultsContainer.innerHTML = `<div class="p-3 text-red-500">Erro ao buscar.</div>`;
                searchResultsContainer.classList.remove('hidden');
            }
        }

        /**
         * Lida com o envio do formulário
         */
        async function handleSubmit(event) {
            event.preventDefault(); // Impede o envio padrão do formulário
            
            // Validação
            if (!selectedProcedimento || codigoSusInput.value !== selectedProcedimento.codigo_sus) {
                showMessage('error', 'Erro: Procedimento inválido. Por favor, selecione um da lista de busca.');
                return;
            }
            if (!mesSelect.value || !anoSelect.value || !quantidadeInput.value || quantidadeInput.value <= 0) {
                showMessage('error', 'Erro: Todos os campos (Mês, Ano, Quantidade) são obrigatórios.');
                return;
            }

            // Confirmação do usuário
            // Usamos window.confirm() pois estamos no contexto de um aplicativo web
            const confirmMessage = `
                Confirma o registro?
                ---------------------------
                Procedimento: ${selectedProcedimento.nome}
                Código: ${selectedProcedimento.codigo_sus}
                Período: ${mesSelect.value}/${anoSelect.value}
                Quantidade: ${quantidadeInput.value}
            `;
            
            if (!confirm(confirmMessage)) {
                return; // Usuário cancelou
            }

            // Prepara os dados para envio
            const payload = {
                codigo_sus: selectedProcedimento.codigo_sus,
                ano: parseInt(anoSelect.value),
                mes: parseInt(mesSelect.value),
                quantidade: parseInt(quantidadeInput.value)
            };

            // Desabilita o botão para evitar cliques duplos
            submitButton.disabled = true;
            submitButton.textContent = 'Salvando...';

            try {
                const response = await fetch('/api/submit_producao', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showMessage('success', 'Sucesso! Produção registrada.');
                    resetForm(); // Limpa o formulário após o sucesso
                } else {
                    showMessage('error', `Falha no registro: ${result.message || 'Erro desconhecido.'}`);
                }

            } catch (error) {
                console.error("Erro ao enviar formulário:", error);
                showMessage('error', 'Erro de conexão. Tente novamente.');
            } finally {
                // Reabilita o botão
                submitButton.disabled = false;
                submitButton.textContent = 'Registrar Produção';
            }
        }

        // --- Event Listeners ---

        // Input de Busca (com debounce de 300ms)
        procSearchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const term = e.target.value;
            // Se o usuário apagar o input, limpa o resto
            if (term.length === 0) {
                codigoSusInput.value = '';
                valorSigtapInput.value = '';
                selectedProcedimento = null;
            }
            searchTimeout = setTimeout(() => {
                fetchProcedimentos(term);
            }, 300);
        });

        // Clique fora da busca para fechar os resultados
        document.addEventListener('click', (e) => {
            if (!procSearchInput.contains(e.target) && !searchResultsContainer.contains(e.target)) {
                searchResultsContainer.classList.add('hidden');
            }
        });

        // Envio do Formulário
        form.addEventListener('submit', handleSubmit);

        // --- Inicialização ---
        // Popula os dropdowns quando a página carrega
        popularDropdownsData();

    </script>
</body>
</html>