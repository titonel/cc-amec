<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Médicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Toggle Ativo (Verde) */
        .toggle-active:checked { right: 0; border-color: #10B981; }
        .toggle-active:checked + .label-active { background-color: #10B981; }
        
        /* Toggle Sexo (Azul/Rosa) */
        .toggle-sexo:checked { right: 0; border-color: #ec4899; }
        .toggle-sexo:checked + .label-sexo { background-color: #ec4899; }
        .toggle-sexo:not(:checked) + .label-sexo { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto max-w-6xl p-4 flex space-x-6 overflow-x-auto">
            <a href="/" class="text-gray-500 hover:text-blue-600 font-medium transition-colors">PRODUÇÃO</a>
            <a href="/consulta" class="text-gray-500 hover:text-blue-600 font-medium transition-colors">CONSULTA</a>
            <a href="/medicos" class="text-blue-600 font-bold border-b-2 border-blue-600 transition-colors">MÉDICOS</a>
        </div>
    </nav>

    <div class="container mx-auto max-w-6xl p-6">
        
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Cadastro de Médicos</h1>
            <button onclick="novoMedico()" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 transition transform hover:scale-105">
                + Novo Médico
            </button>
        </div>

        <div id="form-container" class="bg-white p-6 rounded-lg shadow mb-8 hidden border-l-4 border-blue-500">
            <div class="flex flex-wrap justify-between items-start mb-6 gap-4">
                <h2 class="text-xl font-semibold text-gray-700" id="form-title">Novo Médico</h2>
                
                <div class="flex gap-6">
                    <!-- Sexo -->
                    <div class="flex items-center">
                        <label class="mr-3 text-sm font-medium text-gray-700 w-20 text-right" id="sexo-label">Masculino</label>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="sexo" id="sexo" class="toggle-sexo absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer outline-none transition-all duration-300 right-6 top-0 border-gray-300"/>
                            <label for="sexo" class="toggle-label label-sexo block overflow-hidden h-6 rounded-full cursor-pointer transition-all duration-300"></label>
                        </div>
                    </div>

                    <!-- Ativo -->
                    <div class="flex items-center">
                        <label for="ativo" class="mr-3 text-sm font-medium text-gray-700">Ativo?</label>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="ativo" id="ativo" class="toggle-checkbox toggle-active absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer outline-none transition-all duration-300 right-6 top-0 border-gray-300"/>
                            <label for="ativo" class="toggle-label label-active block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-all duration-300"></label>
                        </div>
                    </div>
                </div>
            </div>

            <form id="medico-form" class="space-y-4">
                <input type="hidden" id="medico-id">
                
                <!-- Atividade -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-blue-50 p-4 rounded-md border border-blue-100 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Início de Atividade</label>
                        <input type="date" id="inicio_ativ" class="w-full border rounded px-3 py-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Fim de Atividade</label>
                        <input type="date" id="fim_ativ" class="w-full border rounded px-3 py-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Dados Pessoais -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="nome" class="w-full border rounded px-3 py-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">CRM</label>
                        <input type="text" id="crm" class="w-full border rounded px-3 py-2 focus:ring-blue-500" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Data Nasc.</label>
                        <input type="date" id="dn" class="w-full border rounded px-3 py-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">CPF</label>
                        <input type="text" id="cpf" class="w-full border rounded px-3 py-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">RG</label>
                        <input type="text" id="rg" class="w-full border rounded px-3 py-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Nacionalidade e Naturalidade -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">País de Nacionalidade</label>
                        <input type="text" id="nacionalidade" class="w-full border rounded px-3 py-2 focus:ring-blue-500" placeholder="Ex: Brasil">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Naturalidade (Cidade)</label>
                        <input type="text" id="naturalidade" class="w-full border rounded px-3 py-2 focus:ring-blue-500" placeholder="Ex: São Paulo">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">UF Naturalidade</label>
                        <select id="estado_natural" class="w-full border rounded px-3 py-2 bg-white focus:ring-blue-500">
                            <option value="">UF</option>
                            <option value="AC">AC</option>
                            <option value="AL">AL</option>
                            <option value="AP">AP</option>
                            <option value="AM">AM</option>
                            <option value="BA">BA</option>
                            <option value="CE">CE</option>
                            <option value="DF">DF</option>
                            <option value="ES">ES</option>
                            <option value="GO">GO</option>
                            <option value="MA">MA</option>
                            <option value="MT">MT</option>
                            <option value="MS">MS</option>
                            <option value="MG">MG</option>
                            <option value="PA">PA</option>
                            <option value="PB">PB</option>
                            <option value="PR">PR</option>
                            <option value="PE">PE</option>
                            <option value="PI">PI</option>
                            <option value="RJ">RJ</option>
                            <option value="RN">RN</option>
                            <option value="RS">RS</option>
                            <option value="RO">RO</option>
                            <option value="RR">RR</option>
                            <option value="SC">SC</option>
                            <option value="SP">SP</option>
                            <option value="SE">SE</option>
                            <option value="TO">TO</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Especialidade</label>
                        <!-- MODIFICADO: Select populado dinamicamente -->
                        <select id="especialidade" class="w-full border rounded px-3 py-2 bg-white focus:ring-blue-500">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" class="w-full border rounded px-3 py-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Endereço -->
                <div class="border-t pt-4 mt-2">
                    <h3 class="text-sm font-bold text-gray-500 uppercase mb-3">Endereço e Contato</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">DDD</label>
                            <input type="text" id="tel_ddd" class="w-full border rounded px-3 py-2 focus:ring-blue-500" maxlength="2" placeholder="XX">
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700">Celular</label>
                            <input type="text" id="tel_cel" class="w-full border rounded px-3 py-2 focus:ring-blue-500" maxlength="10" pattern="\d{5}-\d{4}" title="Formato obrigatório: 99999-9999" placeholder="99999-9999">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div class="relative">
                            <label class="block text-sm font-medium text-gray-700">CEP</label>
                            <input type="text" id="cep_res" class="w-full border rounded px-3 py-2 pr-8 focus:ring-blue-500" placeholder="00000-000" maxlength="9" pattern="\d{5}-\d{3}">
                            <div class="absolute bottom-2 right-2 text-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <p id="cep-status" class="text-xs text-blue-600 mt-1 hidden">Buscando...</p>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Endereço (Logradouro)</label>
                            <input type="text" id="end_res" class="w-full border rounded px-3 py-2 bg-gray-50">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Número</label>
                            <input type="text" id="num_res" class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Complemento</label>
                            <input type="text" id="comp_res" class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Bairro</label>
                            <input type="text" id="bairro_res" class="w-full border rounded px-3 py-2 bg-gray-50">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Cidade</label>
                            <input type="text" id="cidade_res" class="w-full border rounded px-3 py-2 bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Estado (UF)</label>
                            <select id="estado_res" class="w-full border rounded px-3 py-2 bg-white focus:ring-blue-500">
                                <option value="">UF</option>
                                <option value="AC">AC</option>
                                <option value="AL">AL</option>
                                <option value="AP">AP</option>
                                <option value="AM">AM</option>
                                <option value="BA">BA</option>
                                <option value="CE">CE</option>
                                <option value="DF">DF</option>
                                <option value="ES">ES</option>
                                <option value="GO">GO</option>
                                <option value="MA">MA</option>
                                <option value="MT">MT</option>
                                <option value="MS">MS</option>
                                <option value="MG">MG</option>
                                <option value="PA">PA</option>
                                <option value="PB">PB</option>
                                <option value="PR">PR</option>
                                <option value="PE">PE</option>
                                <option value="PI">PI</option>
                                <option value="RJ">RJ</option>
                                <option value="RN">RN</option>
                                <option value="RS">RS</option>
                                <option value="RO">RO</option>
                                <option value="RR">RR</option>
                                <option value="SC">SC</option>
                                <option value="SP">SP</option>
                                <option value="SE">SE</option>
                                <option value="TO">TO</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="cancelarEdicao()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded shadow hover:bg-blue-700 transition">Salvar Dados</button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CRM</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Especialidade</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody id="lista-medicos" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <script>
        const formContainer = document.getElementById('form-container');
        const form = document.getElementById('medico-form');
        const lista = document.getElementById('lista-medicos');
        const cepInput = document.getElementById('cep_res');
        const cepStatus = document.getElementById('cep-status');
        const sexoToggle = document.getElementById('sexo');
        const sexoLabel = document.getElementById('sexo-label');
        
        const dddInput = document.getElementById('tel_ddd');
        const celInput = document.getElementById('tel_cel');
        
        const textFields = ['nome', 'crm', 'dn', 'especialidade', 'nacionalidade', 'naturalidade', 'estado_natural', 'tel_ddd', 'tel_cel', 'email', 'cpf', 'rg', 'cep_res', 'end_res', 'num_res', 'comp_res', 'bairro_res', 'cidade_res', 'estado_res', 'inicio_ativ', 'fim_ativ'];

        // --- INICIALIZAÇÃO: Carrega especialidades ---
        async function carregarEspecialidades() {
            const sel = document.getElementById('especialidade');
            try {
                const res = await fetch('/api/especialidades_amec');
                const list = await res.json();
                if (list.length > 0) {
                    sel.innerHTML = '<option value="">Selecione...</option>' + 
                        list.map(e => `<option value="${e}">${e}</option>`).join('');
                }
            } catch (e) { console.error("Erro ao carregar especialidades", e); }
        }
        carregarEspecialidades();

        function novoMedico() {
            form.reset();
            document.getElementById('medico-id').value = '';
            document.getElementById('form-title').innerText = 'Novo Médico';
            document.getElementById('ativo').checked = true;
            sexoToggle.checked = false; 
            updateSexoLabel();
            formContainer.classList.remove('hidden');
            formContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function cancelarEdicao() {
            formContainer.classList.add('hidden');
            form.reset();
        }

        function updateSexoLabel() {
            if(sexoToggle.checked) {
                sexoLabel.textContent = "Feminino";
                sexoLabel.className = "mr-3 text-sm font-bold text-pink-600 w-20 text-right";
            } else {
                sexoLabel.textContent = "Masculino";
                sexoLabel.className = "mr-3 text-sm font-bold text-blue-600 w-20 text-right";
            }
        }
        sexoToggle.addEventListener('change', updateSexoLabel);

        // Validações
        dddInput.addEventListener('input', (e) => { e.target.value = e.target.value.replace(/\D/g, '').slice(0, 2); });
        celInput.addEventListener('input', (e) => {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 9) val = val.slice(0, 9);
            if (val.length > 5) val = val.slice(0, 5) + '-' + val.slice(5);
            e.target.value = val;
        });
        cepInput.addEventListener('input', (e) => {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 8) val = val.slice(0, 8);
            if (val.length > 5) val = val.slice(0, 5) + '-' + val.slice(5);
            e.target.value = val;
        });

        cepInput.addEventListener('blur', async (e) => {
            const cep = e.target.value.replace(/\D/g, '');
            if (cep.length !== 8) return;
            cepStatus.classList.remove('hidden');
            cepStatus.textContent = "Buscando...";
            try {
                const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await res.json();
                if (!data.erro) {
                    document.getElementById('end_res').value = data.logradouro;
                    document.getElementById('bairro_res').value = data.bairro;
                    document.getElementById('cidade_res').value = data.localidade;
                    if (data.uf) document.getElementById('estado_res').value = data.uf;
                    document.getElementById('num_res').focus();
                    cepStatus.classList.add('hidden');
                } else { cepStatus.textContent = "Não encontrado."; }
            } catch { cepStatus.textContent = "Erro."; }
        });

        async function carregarMedicos() {
            const res = await fetch('/api/medicos');
            const data = await res.json();
            lista.innerHTML = data.map(m => {
                const isAtivo = m.ativo == '1' || m.ativo === 1;
                const badge = isAtivo ? '<span class="px-2 text-xs font-semibold rounded-full bg-green-100 text-green-800">Ativo</span>' : '<span class="px-2 text-xs font-semibold rounded-full bg-red-100 text-red-800">Inativo</span>';
                return `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4">${badge}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">${m.nome}</td>
                    <td class="px-6 py-4 text-gray-600">${m.crm}</td>
                    <td class="px-6 py-4 text-gray-600">${m.especialidade || '-'}</td>
                    <td class="px-6 py-4 text-right text-sm"><button onclick='editarMedico(${JSON.stringify(m)})' class="text-indigo-600 hover:text-indigo-900 font-bold">Editar</button></td>
                </tr>`
            }).join('');
        }

        function editarMedico(m) {
            document.getElementById('medico-id').value = m.id;
            document.getElementById('form-title').innerText = 'Editar Médico';
            textFields.forEach(f => {
                const el = document.getElementById(f);
                if(el) el.value = m[f] || '';
            });
            document.getElementById('ativo').checked = (m.ativo == '1' || m.ativo === 1);
            sexoToggle.checked = (m.sexo == '1' || m.sexo === 1);
            updateSexoLabel();
            formContainer.classList.remove('hidden');
            formContainer.scrollIntoView({ behavior: 'smooth' });
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('medico-id').value;
            const payload = {};
            textFields.forEach(f => payload[f] = document.getElementById(f).value);
            payload['ativo'] = document.getElementById('ativo').checked ? '1' : '0';
            payload['sexo'] = sexoToggle.checked ? '1' : '0';

            const url = id ? `/api/medicos/${id}` : '/api/medicos';
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if (result.success) {
                    alert('Salvo com sucesso!');
                    cancelarEdicao();
                    carregarMedicos();
                } else {
                    alert('Erro: ' + result.message);
                }
            } catch { alert('Erro de conexão.'); }
        });

        carregarMedicos();
    </script>
</body>
</html>