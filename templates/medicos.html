<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Médicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos para o Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981; /* green-500 */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10B981; /* green-500 */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Navegação -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto max-w-6xl p-4 flex space-x-6 overflow-x-auto">
            <a href="/" class="text-gray-500 hover:text-blue-600 font-medium transition-colors">PRODUÇÃO</a>
            <a href="/consulta" class="text-gray-500 hover:text-blue-600 font-medium transition-colors">CONSULTA</a>
            <a href="/medicos" class="text-blue-600 font-bold border-b-2 border-blue-600 transition-colors">MÉDICOS</a>
        </div>
    </nav>

    <div class="container mx-auto max-w-6xl p-6">
        
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Cadastro de Médicos</h1>
            <button onclick="novoMedico()" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 transition transform hover:scale-105">
                + Novo Médico
            </button>
        </div>

        <!-- Formulário -->
        <div id="form-container" class="bg-white p-6 rounded-lg shadow mb-8 hidden border-l-4 border-blue-500">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-semibold text-gray-700" id="form-title">Novo Médico</h2>
                
                <!-- Campo ATIVO (Toggle) -->
                <div class="flex items-center">
                    <label for="ativo" class="mr-3 text-sm font-medium text-gray-700">Cadastro Ativo?</label>
                    <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="ativo" id="ativo" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer outline-none transition-all duration-300 right-6 top-0 border-gray-300"/>
                        <label for="ativo" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-all duration-300"></label>
                    </div>
                </div>
            </div>

            <form id="medico-form" class="space-y-4">
                <input type="hidden" id="medico-id">
                
                <!-- Seção de Atividade -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-blue-50 p-4 rounded-md border border-blue-100 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Início de Atividade</label>
                        <input type="date" id="inicio_ativ" class="w-full border rounded px-3 py-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Fim de Atividade</label>
                        <input type="date" id="fim_ativ" class="w-full border rounded px-3 py-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Dados Pessoais -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="nome" class="w-full border rounded px-3 py-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">CRM</label>
                        <input type="text" id="crm" class="w-full border rounded px-3 py-2 focus:ring-blue-500" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Data Nasc.</label>
                        <input type="date" id="dn" class="w-full border rounded px-3 py-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">CPF</label>
                        <input type="text" id="cpf" class="w-full border rounded px-3 py-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">RG</label>
                        <input type="text" id="rg" class="w-full border rounded px-3 py-2 focus:ring-blue-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Especialidade</label>
                        <input type="text" id="especialidade" class="w-full border rounded px-3 py-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" class="w-full border rounded px-3 py-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Contato e Endereço (Collapsible opcional) -->
                <div class="border-t pt-4 mt-2">
                    <h3 class="text-sm font-bold text-gray-500 uppercase mb-3">Endereço e Contato</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">DDD</label>
                            <input type="text" id="tel_ddd" class="w-full border rounded px-3 py-2">
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700">Celular</label>
                            <input type="text" id="tel_cel" class="w-full border rounded px-3 py-2">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">CEP</label>
                            <input type="text" id="cep_res" class="w-full border rounded px-3 py-2">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Endereço</label>
                            <input type="text" id="end_res" class="w-full border rounded px-3 py-2">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Número</label>
                            <input type="text" id="num_res" class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Complemento</label>
                            <input type="text" id="comp_res" class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Bairro</label>
                            <input type="text" id="bairro_res" class="w-full border rounded px-3 py-2">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Cidade</label>
                            <input type="text" id="cidade_res" class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Estado (UF)</label>
                            <input type="text" id="estado_res" class="w-full border rounded px-3 py-2" maxlength="2">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 hidden">
                        <input type="text" id="nacionalidade" class="border rounded px-3 py-2 text-sm">
                        <input type="text" id="naturalidade" class="border rounded px-3 py-2 text-sm">
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="cancelarEdicao()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded shadow hover:bg-blue-700 transition">Salvar Dados</button>
                </div>
            </form>
        </div>

        <!-- Lista -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CRM</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Especialidade</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody id="lista-medicos" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <script>
        const formContainer = document.getElementById('form-container');
        const form = document.getElementById('medico-form');
        const lista = document.getElementById('lista-medicos');
        
        // Campos de texto (Excluindo ativo que é checkbox)
        const textFields = ['nome', 'crm', 'dn', 'especialidade', 'nacionalidade', 'naturalidade', 'tel_ddd', 'tel_cel', 'email', 'cpf', 'rg', 'cep_res', 'end_res', 'num_res', 'comp_res', 'bairro_res', 'cidade_res', 'estado_res', 'inicio_ativ', 'fim_ativ'];

        function novoMedico() {
            form.reset();
            document.getElementById('medico-id').value = '';
            document.getElementById('form-title').innerText = 'Novo Médico';
            document.getElementById('ativo').checked = true; // Default ativo
            
            formContainer.classList.remove('hidden');
            formContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function cancelarEdicao() {
            formContainer.classList.add('hidden');
            form.reset();
        }

        async function carregarMedicos() {
            const res = await fetch('/api/medicos');
            const data = await res.json();
            
            lista.innerHTML = data.map(m => {
                const isAtivo = m.ativo == '1' || m.ativo === 1;
                const statusBadge = isAtivo 
                    ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Ativo</span>'
                    : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Inativo</span>';
                
                return `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${m.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600">${m.crm}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600">${m.especialidade || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick='editarMedico(${JSON.stringify(m)})' class="text-indigo-600 hover:text-indigo-900 font-bold">Editar</button>
                    </td>
                </tr>
            `}).join('');
        }

        function editarMedico(m) {
            document.getElementById('medico-id').value = m.id;
            document.getElementById('form-title').innerText = 'Editar Médico';
            
            // Preenche campos de texto
            textFields.forEach(f => {
                const el = document.getElementById(f);
                if(el) el.value = m[f] || '';
            });

            // Trata o Toggle (Se for 1 ou '1', marca)
            document.getElementById('ativo').checked = (m.ativo == '1' || m.ativo === 1);

            formContainer.classList.remove('hidden');
            formContainer.scrollIntoView({ behavior: 'smooth' });
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('medico-id').value;
            
            const payload = {};
            textFields.forEach(f => payload[f] = document.getElementById(f).value);
            
            // Captura valor do Toggle (1 se marcado, 0 se não)
            payload['ativo'] = document.getElementById('ativo').checked ? '1' : '0';

            const url = id ? `/api/medicos/${id}` : '/api/medicos';
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if (result.success) {
                    alert('Salvo com sucesso!');
                    cancelarEdicao();
                    carregarMedicos();
                } else {
                    alert('Erro: ' + result.message);
                }
            } catch (err) {
                console.error(err);
                alert('Erro de conexão.');
            }
        });

        // Init
        carregarMedicos();
    </script>
</body>
</html>